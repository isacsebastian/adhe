<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Result</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #ffffff;
            color: #333;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #2a5298;
            text-transform: uppercase;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background-color: #f9f9f9;
            color: #333;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #2a5298;
            color: #fff;
            text-transform: uppercase;
        }

        tr:nth-child(even) {
            background-color: #f1f1f1;
        }

        tr:nth-child(odd) {
            background-color: #e3e3e3;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 20px;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            border-color: #2a5298;
        }

        .total-cell {
            font-weight: bold;
            background-color: #e3e3e3;
            border-radius: 20px;
        }

        .green {
            background-color: #4caf50;
            color: #fff;
            border-radius: 20px;
        }

        .red {
            background-color: #f44336;
            color: #fff;
            border-radius: 20px;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 12px 25px;
            background: linear-gradient(135deg, #1e3c72, #4caf50);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease, background 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background: linear-gradient(135deg, #4caf50, #2a5298);
            transform: scale(1.05);
        }

        select, input {
            width: 50%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 16px;
        }

        .nuevo-producto {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .des-container{
            display: flex;
            flex-direction: column;
            justify-content: center; /* Centra horizontalmente */
            align-items: center;    /* Centra verticalmente */
        }

        .center-container {
            display: flex;
            justify-content: center; /* Centra horizontalmente */
            align-items: center;    /* Centra verticalmente */
            height: 30vh;          /* Altura completa del viewport */
        }

        svg {
            width: 30%; /* Ajusta el tamaño según lo necesites */
            height: auto;
        }
    </style>
<script>
    // Función para actualizar el total dinámicamente
    function updateTotal(rowId) {
        const pedido1Input = document.getElementById(`pedido1-${rowId}`);
        const pedido2Input = document.getElementById(`pedido2-${rowId}`);
        const totalCell = document.getElementById(`total-${rowId}`);
        const referenciaCell = document.getElementById(`referencia-${rowId}`);

        const pedido1 = parseFloat(pedido1Input.value) || 0;
        const pedido2 = parseFloat(pedido2Input.value) || 0;
        const referencia = parseFloat(referenciaCell.textContent) || 0;

        const total = pedido1 + pedido2;

        totalCell.textContent = total.toFixed(2);

        if (total > referencia) {
            totalCell.classList.remove('red');
            totalCell.classList.add('green');
        } else {
            totalCell.classList.remove('green');
            totalCell.classList.add('red');
        }
    }

    // Función para cargar productos según la categoría seleccionada
    function loadProducts() {
        const categoria = document.getElementById("categoria").value;
        const productoSelect = document.getElementById("producto");

        productoSelect.innerHTML = '<option value="">Cargando productos...</option>';

        fetch(`/products_by_category?categoria=${encodeURIComponent(categoria)}`)
            .then(response => response.json())
            .then(data => {
                if (data.products && data.products.length > 0) {
                    productoSelect.innerHTML = '<option value="">Seleccione un producto</option>';
                    data.products.forEach(product => {
                        const option = document.createElement("option");
                        option.value = product;
                        option.textContent = product;
                        productoSelect.appendChild(option);
                    });
                } else {
                    productoSelect.innerHTML = '<option value="">No hay productos disponibles</option>';
                }
            })
            .catch(error => {
                console.error("Error al cargar productos:", error);
                productoSelect.innerHTML = '<option value="">Error al cargar productos</option>';
            });
    }

    // Manejador para el botón de descarga de CSV
    document.querySelector("form[action='/download_filtered_data']").addEventListener('submit', (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);

        fetch('/download_filtered_data', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                return response.json().then(err => {
                    throw new Error(err.error || "Error desconocido.");
                });
            }
        })
        .then(blob => {
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = 'filtered_data.csv';
            link.click();
        })
        .catch(error => {
            alert(`Error al descargar el archivo: ${error.message}`);
        });
    });
</script>

</head>
<body>
    <div class="container">
        <h1>Resultado de Pedidos</h1>
        
<div class="center-container">
    <?xml version="1.0" encoding="UTF-8"?>
    <svg id="Layer_2" data-name="Layer 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 163.16 85.34">
      <defs>
        <style>
          .cls-1 {
            fill: #e00613;
          }
    
          .cls-2 {
            fill: #005ca6;
          }
    
          .cls-3 {
            fill: #f08f00;
          }
    
          .cls-4 {
            fill: #91be1f;
          }
    
          .cls-5 {
            fill: #ffd200;
          }
    
          .cls-6 {
            fill: #0057a3;
          }
    
          .cls-7 {
            fill: #921b80;
          }
    
          .cls-8 {
            fill: #009e97;
          }
        </style>
      </defs>
      <g id="Capa_1" data-name="Capa 1">
        <g>
          <g>
            <path class="cls-1" d="M42.04,58.17v15.53l-18.62-8.81v-6.72c0-5.13,4.18-9.31,9.31-9.31s9.32,4.18,9.32,9.31Z"/>
            <path class="cls-7" d="M18.7,48.31v14.34L.07,53.84v-5.53c0-5.13,4.18-9.31,9.32-9.31s9.31,4.18,9.31,9.31Z"/>
            <path class="cls-5" d="M88.73,62.23v22.53c-6.09.82-12.59.77-18.62-.16v-22.37c0-5.13,4.18-9.31,9.32-9.31s9.31,4.18,9.31,9.31Z"/>
            <path class="cls-3" d="M65.38,52.89v30.8c-2.92-.7-5.66-1.64-8.11-2.79l-10.51-4.97v-23.04c0-5.14,4.18-9.32,9.32-9.32s9.31,4.18,9.31,9.32Z"/>
            <path class="cls-8" d="M135.41,56.13v9.28l-18.62,8.81v-18.09c0-5.13,4.18-9.31,9.32-9.31s9.31,4.18,9.31,9.31Z"/>
            <path class="cls-4" d="M112.06,43.93v32.52l-9.39,4.44c-2.75,1.31-5.89,2.32-9.23,3.05v-40c0-5.13,4.18-9.31,9.31-9.31s9.31,4.18,9.31,9.31Z"/>
            <path class="cls-2" d="M158.74,48.31v6.07l-18.62,8.8v-14.87c0-5.13,4.18-9.31,9.31-9.31s9.31,4.18,9.31,9.31Z"/>
          </g>
          <g>
            <g>
              <path class="cls-6" d="M8.34,6.24c1.32,0,2.52.13,3.6.4,1.08.27,2,.68,2.76,1.24.76.56,1.35,1.27,1.77,2.13.42.86.63,1.88.63,3.05v8.6c0,.66-.17,1.19-.51,1.58-.34.39-.76.73-1.24,1.01-.79.48-1.75.85-2.89,1.1-1.14.25-2.44.38-3.88.38-2.61,0-4.7-.5-6.24-1.5-1.55-1-2.32-2.53-2.32-4.59,0-1.75.52-3.08,1.56-4,1.04-.91,2.64-1.48,4.8-1.71l5.06-.53v-.42c0-.81-.33-1.41-.99-1.79-.66-.38-1.61-.57-2.85-.57-.97,0-1.91.11-2.84.34-.93.23-1.76.49-2.49.8-.3-.2-.57-.51-.78-.93-.22-.42-.32-.87-.32-1.35,0-1.12.58-1.92,1.75-2.4.74-.28,1.59-.49,2.57-.63.98-.14,1.93-.21,2.87-.21ZM8.57,21.43c.56,0,1.11-.06,1.66-.17.55-.11.96-.26,1.24-.44v-3.5l-3.12.27c-.81.08-1.47.26-1.96.55-.5.29-.74.73-.74,1.31s.23,1.09.69,1.45c.46.36,1.21.53,2.25.53Z"/>
              <path class="cls-6" d="M28.8,6.24c.58,0,1.14.04,1.66.13.52.09,1,.21,1.43.36V.34c.28-.08.65-.15,1.1-.23.46-.08.96-.11,1.52-.11,1.14,0,1.96.19,2.46.57.49.38.74,1.1.74,2.17v18.54c0,.61-.13,1.12-.38,1.54-.25.42-.66.81-1.22,1.16-.71.43-1.62.83-2.74,1.18-1.12.36-2.4.53-3.84.53-3.2,0-5.72-.81-7.56-2.42-1.84-1.61-2.76-4.03-2.76-7.25,0-1.67.25-3.12.74-4.34.5-1.22,1.17-2.23,2.04-3.05.86-.81,1.88-1.41,3.05-1.81,1.17-.39,2.42-.59,3.77-.59ZM31.92,11.38c-.33-.15-.69-.29-1.09-.4-.39-.11-.81-.17-1.24-.17-1.37,0-2.46.42-3.27,1.26-.81.84-1.22,2.17-1.22,4s.39,3.03,1.16,3.83c.77.8,1.85,1.2,3.22,1.2.53,0,1.01-.06,1.43-.17.42-.11.75-.25,1.01-.4v-9.14Z"/>
              <path class="cls-6" d="M45.64,25.3c-.46.06-.96.09-1.52.09-1.14,0-1.97-.18-2.47-.55-.51-.37-.76-1.09-.76-2.15V.34c.28-.08.65-.15,1.1-.23s.96-.11,1.52-.11c1.14,0,1.96.19,2.46.57.5.38.74,1.1.74,2.17v4.38c.53-.25,1.14-.46,1.81-.63.67-.16,1.4-.25,2.19-.25,2.44,0,4.35.62,5.73,1.85,1.38,1.23,2.08,3.08,2.08,5.54v11.46c-.25.08-.61.15-1.07.21-.46.06-.96.09-1.52.09-1.14,0-1.97-.18-2.47-.55-.51-.37-.76-1.09-.76-2.15v-8.72c0-1.14-.29-1.95-.86-2.44-.57-.48-1.3-.72-2.19-.72-.58,0-1.12.08-1.6.25-.48.17-.93.36-1.33.59v13.44c-.25.08-.61.15-1.07.21Z"/>
              <path class="cls-6" d="M66.52,18.39c.36,1.07.98,1.82,1.87,2.26.89.44,1.92.67,3.08.67,1.07,0,2.07-.15,3.01-.44.94-.29,1.7-.62,2.28-.97.38.25.7.58.95.99.25.41.38.85.38,1.33,0,.58-.18,1.09-.53,1.52-.36.43-.84.79-1.47,1.09-.62.29-1.36.51-2.21.65-.85.14-1.78.21-2.8.21-1.5,0-2.88-.21-4.15-.63-1.27-.42-2.36-1.04-3.27-1.87-.91-.82-1.63-1.86-2.15-3.1-.52-1.24-.78-2.7-.78-4.38s.26-3.03.78-4.23c.52-1.19,1.22-2.18,2.09-2.97.88-.79,1.88-1.36,3.01-1.73,1.13-.37,2.29-.55,3.48-.55,1.29,0,2.48.2,3.56.59,1.08.39,2,.95,2.78,1.66.77.71,1.38,1.56,1.81,2.55.43.99.65,2.07.65,3.24,0,.81-.22,1.42-.65,1.83-.43.41-1.04.67-1.83.8l-9.9,1.48ZM70.14,10.55c-1.09,0-2,.34-2.72,1.01-.72.67-1.15,1.64-1.28,2.91l7.27-1.18c-.05-.66-.34-1.28-.88-1.87-.53-.58-1.33-.88-2.4-.88Z"/>
              <path class="cls-6" d="M90.14,25.7c-.66,0-1.27-.06-1.83-.17-.56-.11-1.07-.26-1.52-.44v6.81c-.25.08-.61.15-1.07.23-.46.08-.97.11-1.52.11-1.14,0-1.97-.19-2.47-.57s-.76-1.1-.76-2.17V10.66c0-.66.14-1.2.42-1.62.28-.42.67-.79,1.18-1.12.76-.48,1.74-.88,2.93-1.2,1.19-.32,2.51-.48,3.96-.48s2.82.18,4.05.55c1.23.37,2.29.95,3.18,1.73.89.79,1.58,1.79,2.07,3.01.5,1.22.74,2.66.74,4.34s-.23,3.01-.7,4.25c-.47,1.23-1.12,2.26-1.96,3.08-.84.82-1.83,1.45-2.97,1.87-1.14.42-2.39.63-3.73.63ZM89.27,21.09c1.37,0,2.43-.43,3.18-1.29.75-.86,1.12-2.17,1.12-3.92s-.36-3.1-1.09-3.88c-.72-.79-1.73-1.18-3.03-1.18-.58,0-1.09.07-1.52.21-.43.14-.82.3-1.18.48v8.95c.36.2.74.36,1.14.48.41.11.86.17,1.37.17Z"/>
              <path class="cls-6" d="M105.12,25.39c-1.14,0-1.96-.18-2.46-.55-.49-.37-.74-1.09-.74-2.15V.34c.25-.08.61-.15,1.09-.23.47-.08.98-.11,1.54-.11,1.12,0,1.93.19,2.44.57.51.38.76,1.1.76,2.17v22.35c-.28.08-.65.15-1.1.21-.46.06-.97.09-1.52.09Z"/>
              <path class="cls-6" d="M118.35,6.24c1.32,0,2.52.13,3.6.4,1.08.27,2,.68,2.76,1.24.76.56,1.35,1.27,1.77,2.13.42.86.63,1.88.63,3.05v8.6c0,.66-.17,1.19-.51,1.58-.34.39-.76.73-1.24,1.01-.79.48-1.75.85-2.89,1.1-1.14.25-2.44.38-3.88.38-2.61,0-4.7-.5-6.24-1.5-1.55-1-2.32-2.53-2.32-4.59,0-1.75.52-3.08,1.56-4,1.04-.91,2.64-1.48,4.8-1.71l5.06-.53v-.42c0-.81-.33-1.41-.99-1.79-.66-.38-1.61-.57-2.85-.57-.97,0-1.91.11-2.84.34-.93.23-1.76.49-2.49.8-.3-.2-.57-.51-.78-.93-.22-.42-.32-.87-.32-1.35,0-1.12.58-1.92,1.75-2.4.74-.28,1.59-.49,2.57-.63.98-.14,1.93-.21,2.87-.21ZM118.57,21.43c.56,0,1.11-.06,1.66-.17.55-.11.96-.26,1.24-.44v-3.5l-3.12.27c-.81.08-1.47.26-1.96.55-.5.29-.74.73-.74,1.31s.23,1.09.69,1.45c.46.36,1.21.53,2.25.53Z"/>
              <path class="cls-6" d="M145.05,19.76c0,1.88-.7,3.34-2.09,4.4-1.4,1.05-3.45,1.58-6.17,1.58-1.07,0-2.04-.08-2.91-.23-.88-.15-1.63-.38-2.26-.69-.63-.3-1.13-.68-1.49-1.14-.36-.46-.53-.99-.53-1.6,0-.56.11-1.03.34-1.43.23-.39.52-.72.88-.97.74.43,1.57.81,2.51,1.14.94.33,2.03.5,3.27.5,1.8,0,2.7-.51,2.7-1.52,0-.43-.16-.76-.48-.99-.32-.23-.86-.43-1.62-.61l-1.52-.34c-2.08-.43-3.63-1.1-4.64-2-1.02-.9-1.52-2.16-1.52-3.79,0-1.8.73-3.23,2.19-4.28,1.46-1.05,3.42-1.58,5.88-1.58.91,0,1.78.07,2.59.21.81.14,1.51.35,2.09.63.58.28,1.05.63,1.39,1.05.34.42.51.91.51,1.47,0,.51-.1.96-.3,1.35-.2.39-.47.72-.8.97-.2-.13-.5-.27-.89-.42-.39-.15-.82-.29-1.28-.42-.46-.13-.94-.23-1.45-.3-.51-.08-.98-.11-1.41-.11-.89,0-1.58.12-2.07.36-.5.24-.74.6-.74,1.09,0,.36.14.64.42.84.28.2.79.39,1.52.57l1.45.34c2.31.51,3.96,1.24,4.95,2.21.99.96,1.49,2.21,1.49,3.73Z"/>
              <path class="cls-6" d="M153.67,20.61c.46.32,1.09.48,1.9.48.38,0,.79-.04,1.22-.13.43-.09.8-.2,1.1-.32.23.25.42.55.57.88.15.33.23.71.23,1.14,0,.89-.35,1.62-1.05,2.19-.7.57-1.91.86-3.64.86-2.13,0-3.79-.49-4.99-1.47-1.19-.98-1.79-2.57-1.79-4.78V2.36c.28-.08.65-.16,1.1-.25.46-.09.95-.13,1.48-.13,1.12,0,1.92.2,2.42.59.49.39.74,1.11.74,2.15v2.47h5.25c.13.25.25.58.38.97.13.39.19.81.19,1.24,0,.81-.18,1.4-.55,1.75-.37.36-.84.53-1.43.53h-3.84v7.39c0,.71.23,1.22.69,1.54Z"/>
            </g>
            <path class="cls-6" d="M159.95,9.46c0-.22.04-.42.11-.61.08-.19.19-.36.33-.5s.31-.26.5-.34c.2-.08.41-.13.66-.13s.45.04.65.13c.2.09.37.2.51.34.14.14.25.31.33.5.08.19.12.4.12.61s-.04.42-.12.61c-.08.19-.19.36-.33.5-.14.15-.31.26-.51.34-.2.08-.41.12-.65.12s-.46-.04-.66-.12c-.2-.08-.36-.2-.5-.34-.14-.14-.25-.31-.33-.5-.08-.19-.11-.4-.11-.61ZM160.3,9.46c0,.18.03.35.09.51.06.16.14.29.25.4.11.11.24.2.4.27.16.06.33.1.51.1s.36-.03.51-.1c.16-.06.29-.15.4-.27.11-.11.19-.25.25-.4.06-.15.09-.32.09-.51s-.03-.35-.09-.51c-.06-.16-.14-.29-.25-.4-.11-.11-.24-.2-.4-.27-.16-.06-.33-.1-.51-.1s-.36.03-.51.1c-.16.06-.29.15-.4.27-.11.11-.19.25-.25.4-.06.16-.09.32-.09.51ZM161.36,9.63v.51s-.1.01-.17.01c-.05,0-.09,0-.12-.03-.03-.02-.05-.06-.05-.12v-1.18c0-.06.05-.1.14-.11.06-.01.12-.02.17-.03.05,0,.11,0,.17,0,.2,0,.36.04.48.12.12.08.17.2.17.35,0,.11-.03.2-.09.27s-.14.12-.23.15l.36.45s-.03.06-.06.09-.07.04-.12.04c-.08,0-.15-.04-.21-.13l-.27-.4h-.17ZM161.56,9.37c.16,0,.24-.07.24-.22,0-.06-.03-.11-.08-.15-.05-.04-.12-.05-.2-.05-.03,0-.06,0-.09,0-.03,0-.05,0-.08,0v.41h.2Z"/>
          </g>
        </g>
      </g>
    </svg>
</div>

        {% if header_data %}
            <h2>Información General</h2>
            <div class="table-container">
                <table>
                    <tr>
                        <th>Vendedor</th>
                        <th>Cliente</th>
                        <th>Nombre</th>
                    </tr>
                    <tr>
                        <td>{{ header_data['Vendedor'] }}</td>
                        <td>{{ header_data['Cliente'] }}</td>
                        <td>{{ header_data['Nombre'] }}</td>
                    </tr>
                </table>
            </div>
        {% endif %}

        {% if grouped_data %}
            {% for category, rows in grouped_data.items() %}
                <h2>{{ category }} - Enero</h2>
                <div class="table-container">
                    <table>
                        <tr>
                            <th>Material</th>
                            <th>Descripción</th>
                            <th>Presentación</th>
                            <th>Embalaje</th>
                            {% for month in month_columns %}
                                <th>{{ month }}</th>
                            {% endfor %}
                            <th>Pedido1</th>
                            <th>Pedido2</th>
                            <th>Total</th>
                        </tr>
                        {% for row in rows %}
                            <tr>
                                <td>{{ row['Material'] }}</td>
                                <td>{{ row['Descripción'] }}</td>
                                <td>{{ row['Presentación'] }}</td>
                                <td>{{ row['Embalaje'] }}</td>
                                {% for month in month_columns %}
                                    <td id="referencia-{{ row['unique_id'] }}">{{ row['Filtered Months'][month] }}</td>
                                {% endfor %}
                                <td>
                                    <input
                                        type="number"
                                        name="pedido1-{{ row['unique_id'] }}"
                                        id="pedido1-{{ row['unique_id'] }}"
                                        value="{{ row['Pedido1'] }}"
                                        oninput="updateTotal('{{ row['unique_id'] }}')"
                                    >
                                </td>
                                <td>
                                    <input
                                        type="number"
                                        name="pedido2-{{ row['unique_id'] }}"
                                        id="pedido2-{{ row['unique_id'] }}"
                                        value="{{ row['Pedido2'] }}"
                                        oninput="updateTotal('{{ row['unique_id'] }}')"
                                    >
                                </td>
                                <td class="total-cell" id="total-{{ row['unique_id'] }}">
                                    {{ row['Total'] }}
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            {% endfor %}
        {% endif %}
     
        <h2>Agregar Nuevo Producto</h2>
<div class="nuevo-producto">
    <form action="/add_product" method="post">
        <label for="categoria">Seleccione una categoría:</label>
        <br>
        <select name="categoria" id="categoria" required onchange="loadProducts()">
            <option value="">Seleccione una categoría</option>
            {% for categoria in categorias %}
            <option value="{{ categoria }}">{{ categoria }}</option>
            {% endfor %}
        </select>
        
        <label for="producto">Seleccione un producto:</label>
        <br>
        <select name="producto" id="producto" required>
            <option value="">Seleccione una categoría primero</option>
        </select>
        
        <label for="cantidad">Cantidad:</label>
        <br>
        <input type="number" name="cantidad" id="cantidad" required>
        
        <br><br>
        <button type="submit">Agregar Producto</button>
    </form>
</div>
<div class="des-container">
    <form action="/download_filtered_data" method="post">
        <label for="client_id">Cliente ID:</label>
        <input type="text" name="client_id" value="{{ header_data['Cliente'] }}" readonly>
        <br>
        <label for="vendedor">Vendedor ID:</label>
        <input type="text" name="vendedor" value="{{ header_data['Vendedor'] }}" readonly>
        <button type="submit">Descargar CSV Filtrado</button>
    </form>
</div>

    </div>
</body>
</html>
